<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>All Departments</title>
		<style>
			:root{--bg:#f7faf9;--card:#fff;--muted:#6b7280;--accent:#0f766e;--danger:#dc2626}
			*{box-sizing:border-box}
			body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;background:var(--bg);color:#0f172a}
			.container{max-width:1100px;margin:28px auto;padding:0 18px}
			h1{font-size:22px;margin:0 0 18px}

			.controls{display:flex;gap:18px;align-items:center;margin-bottom:18px}
			.controls .search{flex:1}
			.controls input[type="search"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #e6e9ef;background:#fff}
			.controls .filter{width:220px}
			.controls select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e6e9ef;background:#fff}

			.table-card{background:var(--card);border-radius:10px;padding:0;overflow:hidden;border:1px solid #eef2f7}
			table{width:100%;border-collapse:collapse}
			thead tr{background:#f3f4f6}
			thead th{padding:14px 18px;text-align:left;font-weight:600;color:#374151;border-bottom:1px solid #eef2f7}
			tbody td{padding:16px 18px;border-bottom:1px solid #f3f4f6;vertical-align:middle}

			tbody tr:nth-child(even){background:#fbfbfb}

			.actions{display:flex;gap:12px;align-items:center}
			.btn-edit{background:#0f766e;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600}
			.btn-edit:hover{opacity:0.95}
			/* styling for inline delete button (btn-deleteDept) */
			.btn-deleteDept{
				background:transparent;
				color:var(--danger);
				border:1px solid rgba(220,38,38,0.06);
				padding:8px 10px;
				border-radius:8px;
				font-weight:600;
				cursor:pointer;
				transition:background-color 0.15s ease, color 0.15s ease, transform 0.08s ease;
			}
			.btn-deleteDept:hover{
				background:rgba(220,38,38,0.08);
				color:var(--danger);
				transform:translateY(-1px);
			}
			/* styled delete button: subtle pill with red text and light red hover background */
			.btn-delete{
				color:var(--danger);
				text-decoration:none;
				font-weight:600;
				padding:8px 10px;
				border-radius:8px;
				background:transparent;
				border:1px solid transparent;
				transition:background-color 0.15s ease, color 0.15s ease;
			}
			.btn-delete:hover{
				background:rgba(220,38,38,0.08);
				color:var(--danger);
				text-decoration:none;
			}

			.table-header-row{display:flex;gap:18px;align-items:center;margin-bottom:10px}

			@media (max-width:820px){
				.controls{flex-direction:column;align-items:stretch}
				.controls .filter{width:100%}
				thead th:nth-child(3), tbody td:nth-child(3){display:none}
			}

			/* place Create Department button to the right of the heading */
			.container{position:relative}
			/* base style for both buttons */
			button.btn-toCreateDept{
				position:absolute;
				top:8px;
				background:var(--accent);
				color:#fff;
				padding:8px 12px;
				border-radius:10px;
				border:none;
				font-weight:700;
				cursor:pointer;
			}
			/* place the last button at the right edge and the previous one slightly left */
			button.btn-toCreateDept:last-of-type{right:18px}
			/* move the first button further left to create visible gap */
			button.btn-toCreateDept:first-of-type{right:198px}
			button.btn-toCreateDept a{color:inherit;text-decoration:none;display:inline-block}
			@media (max-width:820px){
				button.btn-toCreateDept{position:static;display:block;margin:12px 0 6px 0}
			}
		</style>
		<!-- SweetAlert2 -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	</head>
	<body>
		<div class="container">
			<h1>All Departments</h1>
			<button class="btn-toCreateDept"><a href="/admin/dashboard">Home</a></button>
			<button class="btn-toCreateDept"><a href="/admin/departments/create">Create Department</a></button>
			<form class="controls" action="/admin/departments" method="GET">
				<div class="search">
					<input type="search" name="q" placeholder="Search by department name" value="<%= typeof q !== 'undefined' ? q : '' %>">
				</div>

				<div class="filter">
					<select name="type">
						<option value="">All</option>
						<option value="academic" <%= type === 'academic' ? 'selected' : '' %>>academic</option>
						<option value="administrative" <%= type === 'administrative' ? 'selected' : '' %>>administrative</option>
						<option value="research" <%= type === 'research' ? 'selected' : '' %>>research</option>
						<option value="support" <%= type === 'support' ? 'selected' : '' %>>support</option>
					</select>
				</div>
				<button type="submit" style="padding:10px 16px;border:none;border-radius:10px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;">Apply</button>
			</form>

			<div class="table-card">
				<table>
					<thead>
						<tr>
							<th>Department Name</th>
							<th>Type</th>
							<th>Number of Users</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						<% if (Array.isArray(departments) && departments.length) { %>
							<% departments.forEach(function(dept){ %>
								<tr>
									<td><%= dept.name %></td>
									<td><%= dept.type %></td>
									<td><%= typeof dept.userCount !== 'undefined' ? dept.userCount : 0 %></td>
									<td>
										<div class="actions">
											<a class="btn-edit" href="/admin/departments/<%= dept.id %>/edit">Edit</a>
											<button class="btn-deleteDept" onclick="confirmDelete('<%= dept.id%>')">Delete</button>
										</div>
									</td>
								</tr>
							<% }) %>
						<% } else { %>
							<tr>
								<td colspan="4" style="padding:20px 18px;color:#6b7280">No departments found.</td>
							</tr>
						<% } %>
					</tbody>
				</table>
			</div>
			<% if (totalPages >1) { %>
				<div class="pagination">
					<% for (let i = 1; i <= totalPages; i++) { %>
					<a 
						href="?page=<%= i %><%= q ? `&q=${q}` : '' %><%= type ? `&type=${type}` : '' %>"
						class="page-btn <%= i === page ? 'active' : '' %>"
					>
						<%= i %>
					</a>
					<% } %>
				</div>
			<% } %>

		</div>
		<script>
			async function confirmDelete(id) {
				const result = await Swal.fire({
					title: "Delete Department?",
					text: "This action cannot be undone.",
					icon: "warning",
					showCancelButton: true,
					confirmButtonText: "Yes, delete",
					cancelButtonText: "Cancel",
					confirmButtonColor: "#dc2626",
				});

				if (!result.isConfirmed) return;

				try {
					const res = await fetch(`/admin/departments/${id}/delete`, {
						method: "DELETE"
					});
					const data = await res.json();

					if (!data.success) {
						Swal.fire({
							title: "Error",
							text: data.message,
							icon: "error",
						});
						return;
					}

					Swal.fire({
						title: "Deleted!",
						text: data.message,
						icon: "success",
						timer: 1500,
						showConfirmButton: false,
					}).then(() => location.reload());

				} catch (error) {
					console.log(error);
					Swal.fire({
						title: "Error",
						text: "An error occurred while deleting department.",
						icon: "error",
					});
				}
			}
			</script>
	</body>
</html>

