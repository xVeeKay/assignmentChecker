<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>All Users</title>
    <style>
      :root {
        --primary: #14919b;
        --border: #d1d5db;
        --error: #dc2626;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, sans-serif;
        background: #f3f4f6;
        color: #111827;
        line-height: 1.5;
      }

      .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
      }

      h1 {
        font-size: 1.875rem;
        font-weight: 600;
        margin-bottom: 2rem;
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .btn-home {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.45rem 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border);
        background: #ffffff;
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
      }

      .btn-home:hover,
      .btn-home:focus {
        background: #f8fafb;
      }

      .filters {
        display: grid;
        /* added an auto column for the Apply button so it sits inline */
        grid-template-columns: 2fr 1fr 1fr auto;
        gap: 1rem;
        margin-bottom: 2rem;
        align-items: center;
      }

      .search-input {
        width: 100%;
        padding: 0.625rem 1rem;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        font-size: 0.875rem;
      }

      .select {
        width: 100%;
        padding: 0.625rem 2rem 0.625rem 1rem;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        font-size: 0.875rem;
        background: white;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      }

      th {
        background: #f9fafb;
        padding: 0.75rem 1rem;
        font-weight: 500;
        text-align: left;
        font-size: 0.875rem;
        color: #374151;
      }

      td {
        padding: 1rem;
        border-top: 1px solid #f3f4f6;
        font-size: 0.875rem;
      }

      tr:hover {
        background: #f9fafb;
      }

      .actions {
        display: flex;
        gap: 0.5rem;
      }

      .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
      }

      .btn-edit {
        background: var(--primary);
        color: white;
      }

      .btn-delete {
        background: white;
        border: 1px solid var(--border);
        color: var(--error);
      }

      /* Apply button used by the filters form */
      .form-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }

      .btn-apply {
        background: var(--primary);
        color: #fff;
        padding: 0.55rem 0.95rem;
        border-radius: 0.5rem;
        border: none;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(20,145,155,0.12);
        transition: background-color 120ms ease, transform 120ms ease;
      }

      .btn-apply:hover,
      .btn-apply:focus {
        background: #0f7e83;
        transform: translateY(-1px);
      }

      .error {
        background: #fff1f2;
        color: #b91c1c;
        padding: 0.6rem 0.9rem;
        border-radius: 8px;
        margin-bottom: 1rem;
      }

      .success {
        background: #ecfdf5;
        color: #065f46;
        padding: 0.6rem 0.9rem;
        border-radius: 8px;
        margin-bottom: 1rem;
      }


      .name-cell {
        font-weight: 500;
        color: #111827;
      }

      .email-cell {
        color: #4b5563;
      }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  </head>
  <body>
    <div class="container">
      <div class="top-bar">
        <h1>All Users</h1>
        <a href="/admin/dashboard" class="btn-home">Home</a>
      </div>

      <% if (typeof error !== 'undefined' && error) { %>
        <div class="error"><%= error %></div>
      <% } %>

      <% if (typeof success !== 'undefined' && success) { %>
        <div class="success"><%= success %></div>
      <% } %>

      <form action="/admin/users" method="get">
    <div class="filters">
      <input
      type="search"
      name="search"
      placeholder="Search by name or email"
      class="search-input"
      value="<%= typeof search !== 'undefined' ? search : '' %>"
      /> 
      <select class="select" name="role" aria-label="Filter by role">
      <option value="">All Roles</option>
      <option value="student" <%= role === 'student' ? 'selected' : '' %>>Student</option>
      <option value="professor" <%= role === 'professor' ? 'selected' : '' %>>Professor</option>
      <option value="hod" <%= role === 'hod' ? 'selected' : '' %>>HOD</option>
      </select>
      <select class="select" name="department" aria-label="Filter by department">
      <option value="">All Departments</option>
      <% if(Array.isArray(departments)&&departments.length){%>
        <%departments.forEach((d)=>{%>
          <option value="<%= d._id %>" <%= department ===  d._id.toString()  ? 'selected' : '' %>><%= d.name %></option>
        <%})%>
      <%}%>
      </select>
      <div class="form-actions">
        <button type="submit" class="btn btn-apply">Apply</button>
      </div>
    </div>
      </form>

      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Department</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(user => { %>
          <tr>
            <td class="name-cell"><%= user.name %></td>
            <td class="email-cell"><%= user.email %></td>
            <td><%= user.role %></td>
            <td><%= user.department.name %></td>
            <td class="actions">
              <button class="btn btn-edit"><a style="text-decoration: none;color: white;" href="/admin/users/<%= user._id%>/edit">Edit</a></button>
              <button class="btn btn-delete" onclick="deleteUser('<%= user._id %>')">Delete</button>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
      <% if (totalPages > 1) { %>
        <div class="pagination" style="margin-top:20px; display:flex; gap:8px; justify-content:center;">

            <% if (page > 1) { %>
            <a href="?page=<%= page - 1 %>&role=<%= role || '' %>&department=<%= department || '' %>&search=<%= search || '' %>">Prev</a>
            <% } %>

            <% for (let i = 1; i <= totalPages; i++) { %>
            <a 
                href="?page=<%= i %>&role=<%= role || '' %>&department=<%= department || '' %>&search=<%= search || '' %>"
                class="<%= page === i ? 'active' : '' %>"
                style="padding:6px 12px; border:1px solid #ccc; border-radius:5px; text-decoration:none;"
            ><%= i %></a>
            <% } %>

            <% if (page < totalPages) { %>
            <a href="?page=<%= page + 1 %>&role=<%= role || '' %>&department=<%= department || '' %>&search=<%= search || '' %>">Next</a>
            <% } %>

        </div>
      <% } %>
    </div>
      <script>
        async function deleteUser(userId) {
          const result = await Swal.fire({
            title: "Delete User?",
            text: "This action cannot be undone.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete",
            cancelButtonText: "Cancel",
            confirmButtonColor: "#dc2626",
          });
          if (!result.isConfirmed) return;
          try {
            const res = await fetch(`/admin/users/${userId}/delete`, {
              method: "DELETE",
            });
            const data = await res.json();
            if (!data.success) {
              Swal.fire({
                title: "Error",
                text: data.message,
                icon: "error",
              });
              return;
            }

            Swal.fire({
              title: "Deleted!",
              text: data.message,
              icon: "success",
              timer: 1500,
              showConfirmButton: false,
            }).then(() => location.reload());

          } catch (err) {
            console.error(err);
            Swal.fire({
              title: "Error",
              text: "Error deleting user.",
              icon: "error",
            });
          }
        }
        </script>
  </body>
</html>
